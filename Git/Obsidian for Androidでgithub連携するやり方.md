### 前提
まず前提として、「Obsidian Git」というコミュニティプラグインを使用することで、Obsidianとgithubの連携をすることができる。

連携を行うとどうなるかというと、Obsidian上からリモートリポジトリに直接プッシュしたり、コミットしたりすることができるようになる。

PC上のObsidianでは既に「Obsidian Git」を使用してgithubとの連携をしていたのだけど、今回スマホ版(筆者の場合はAndroid)でもgithubの連携をすることに成功したのでそのやり方をメモしておく。

### 連携の手順

手順は大きく以下の2つに分けることができる。

||手順|
|-|-|
|①|PC上で行う操作|
|②|スマホ上(筆者の場合はAndroid)で行う操作|

順番に見ていく。

### PC上で行う操作

まずPC上でgithubにログインしたら、以下の操作を完了しておく。

||操作|
|-|-|
|①|スマホ上のObsidianからデータを送るためのリモートリポジトリを新規作成。|
|②|アクセストークンの発行を行うがこの時、新規作成したリモートリポジトリへのPermissionを付与する。|

順番に詳しく見ていこう。

#### ①スマホ上のObsidianからデータを送るためのリモートリポジトリを新規作成。

これについては特に問題ないと思う。

名前は自分がわかりやすい名前を付ければok。筆者の場合は「backup-mobile」としておいた。

#### ②アクセストークンの発行を行うがこの時、新規作成したリモートリポジトリへのPermissionを付与する。

まず、アクセストークンの発行を行うページへ移動する必要がある。

移動の手順は以下の通り。

githubにログインしたら画面右上のプロフィールアイコンをクリック。-> settings -> 画面をスクロールして左側の一番下にある「Developer Settings」をクリック。-> Personal access tokens -> Fine-grained tokens

そうすると、右上に「Generate new token」というボタンがあるはずなので、そこをクリック。

「New fine-grained personal access token」というページが開いたら、Token nameを入力。好きな名前でok。

次に同じページの「Repository access」の項目のOnly select repositoriesをクリック -> Select repositoryから最初に作成したリモートリポジトリを選択。

Permissionsの項目が変更できるようになっているはずなので、2種類のパーミッション設定のうちRepository permissionsをクリックして、その中から「Content」の項を探して、Accessの部分を「Read and write」へ変更。

ここまで完了したら、あとは、その他の設定はデフォルトのままで「Generate token」をクリック。

そうすると、アクセストークンが発行される。このアクセストークンは後で使うのでコピーをして、どこかに保存しておく。

### スマホ上で行う操作

このアクセストークンはスマホの方で使用するので、スマホの方でコピペできるようにしておく。

方法としては筆者が思いつくのは以下の2つだが、要はスマホでコピペできればなんでもok。

・自身のgithub上の非公開リポジトリ内にMarkdown形式で保存。それをスマホから開く。

・PC上のobsidianで新規ファイルを作成して、そこにアクセストークンをコピペ。
その後、PCとスマホをUSBなどで接続して、スマホのobsidianフォルダの中に移動させて開く。

このときに、セキュリティリスクが気になる人がいるかもしれない。

#### アクセストークンのセキュリティリスク

仮にアクセストークンが漏洩した場合、どうなるのかについては〜にて以下の記述がある。

上記の引用にある通り、アクセストークンからはアカウントのパスワードなどの情報はわからないので、その点は心配ないが、ただし注意点がある。

どういうことかというと、

今回、アクセストークンに付与した権限は、contentに対する「読み書き」なので、もしもこのアクセストークンが漏洩した場合、今回新たに作成したリポジトリ内のデータが見られたり書き換えられたりする可能性があるということだ。

つまり、「今回新たに作成したリポジトリ内」にアカウントのパスワードをメモしておいた場合は危険。(まさかそんなことをする人はいないと思うが)

たとえアクセストークン事態からはパスワードが漏れなくとも、そのパーミッションが落とし穴になる可能性があるので注意が必要。

### アクセストークンを発行したら

上記の「PC上で行う操作」と「スマホ上で行う操作」が済んだら、あとは以下の記事に書いてある手順に従うだけだ。

https://web.archive.org/web/20230324131832/https://silverbirder.net/entry/2022/10/18/000000

#### 補足

上記の記事を読むにあたって、いくつか補足を書いておく。

・「Authentication/Commit Author」の項目内に、githubのユーザーネームとアクセストークンを入力する欄がある。
アクセストークンの方は、一度入力して画面を閉じると入力内容が表示されなくなるが、実際には入力が反映されているため心配はない。

本当に入力されているかは、githubとの連携ができるかどうかで確認できる。

もし、連携がうまくいかない時はこのアクセストークンの設定を疑う必要がある。

・リポジトリをcloneする手順の時、YESかNOの選択をせまられて、「NO」を選択すると、空欄の長方形が表示されるので必ず選択する。(これをしないと手順が完了しない。空欄なので選択肢だと気づかない場合がある。筆者の場合これにハマった。)

・Author nameとemailの部分が空欄のままだと、連携がうまくいかないので必ず入力する。

Author nameは自由に決めてok。メールアドレスも自分が使用しているアドレスならなんでもok。

・commitやpushを行う時は、「○の中に↑」マークがついているボタンを押せばok。

### エラー

Checkout ConflictError: Your local changes to the following files would be overwritten by checkout: .obsidian/workspace-mobile.json

エラーが発生した経緯

リポジトリをcloneするときにこのエラーが発生した。

### 原因と対処

原因はclone元のリポジトリ内に、obsidianの設定ファイル「.obsidian」が入っていたため衝突が発生していたためだと考えられる。

このclone元の「.obsidian」を削除することで対処できた。

### gitignoreの設定

今後、上記のようなエラーが起きるのを防ぐため、フォルダ「.obsidian」が置いてあるのと同じ階層に「.gitignore」置いた。　

.gitignoreを設定することで、特定のディレクトリのpushやpullを無効化することができる。

デフォルトの状態では、「obsidian git」の設定ファイルまでgithub上にpushされていたため、上記のようなエラーが発生した。そのため、設定ファイル等のpushを無効化することでエラーを防ぐことがねらいだ。

.gitignoreファイルの中には、無視したいディレクトリのパスを入力する。

「.gitignore」はメモ帳で、名前を「.gitignore」としたテキストファイルを作成することで作成できる。

中身には以下を記載した。

```
.trash/
.git/
.obsidian/*
```

ワイルドカード「*」を使用することで、ディレクトリ直下にあるすべてをまとめて無視することができる。


### コントロールビューの使い方

プルやプッシュをする時に使うcontrol viewの使い方をメモしておく。

・「↓」ボタンはpullを意味する。

・pullボタンの隣の「↑」はpushを意味する。

・「+」で上へ(Stage)、「-」で下へディレクトリやファイルを移動する。

・「✓」で確定(Commit)。pushする時に使う。

・一番左の、〇の中に「↑」マークは、pushとかをまとめて行う。(アクセストークンの期限が切れて再連携しなおした時、Stage&pushでうまくいかない時に使うとうまくいった)

#### 具体例

上記の使い方をふまえて、実際にリモートリポジトリへpushする流れを書いてみる。

①ファイルに変更を加える。

②変更を加えたファイルは、control view内の「Changes」に表示される。

③「Changes」に表示されているのを確認できたら、「+」を押してファイルを「Staged Changes」に移動させる。

④「Staged Changes」に移動させたら、「✓」を押して確定。

⑤確定すると、pushボタンが四角の枠で囲われて表示されるので、そこを押す。

⑤「pushed 1 file to remote」というメッセージが表示されたら完了だ。あとはリモートリポジトリの方で変更が反映されているか確認して、反映されていればok。

