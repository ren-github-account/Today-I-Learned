*目次*
* [CDNとは](#CDNとは)
* [必要になった背景](#必要になった背景)
* [デメリット](#デメリット)
* [セキュリティ](#セキュリティ)
* [SRIを使ったCDNの利用方法](#SRIを使ったCDNの利用方法)
* [integrity属性](#integrity属性)
* [crossorigin属性](#crossorigin属性)
* [ドメインとオリジンの違い](#ドメインとオリジンの違い)
* [HTTPリクエスト](#HTTPリクエスト)
* [CORSとは](#CORSとは)
* [同一オリジンポリシー](#同一オリジンポリシー)

### CDNとは

コンテンツを高速で配信するための仕組み。Content Delivery Networkの略。

複数の地域に配置されたサーバーを利用し、各ユーザーに最も近いサーバーからデータを取得することができる。

これは、例えるなら車のトラブルがあった時に来てくれるJAFのサービスに似ている。  
JAFも依頼のあった場所から近い場所に住んでいるJAFスタッフの人が来てくれる。

これと同じように、CDNもユーザーからファイルの要求があったら、そのユーザーの場所に一番近いサーバーを通じてファイルを届ける。  
そのため、**CDNを使うと高速でコンテンツを配信することができる。**

### 必要になった背景

CDNが必要になった背景の一つに、海外からのアクセスがあった際の表示速度を速めることがあげられる。

海外から日本のWebサービスにアクセスする場合、ページの表示までに時間がかかってしまうことがある。

これは**オリジンサーバ**(それぞれのWebサイトを管理しているサーバ)との物理的な距離が遠ければ遠いほど、webページの表示が遅くなるためだ。  
このため海外のユーザーをターゲットとしているWebサービスなどでは、現地でのコンテンツ表示速度の向上が課題となっていた。

### デメリット

便利な反面、デメリットも存在する。

* **CDN提供元の影響を受ける**

CDNを提供しているサービスはいくつかあるが、そのCDNの提供元が障害を起こすことがあり、それが原因でアプリなどのサービスが動かなくなることがある。

そのため、CDNを利用する場合はこういった提供元の影響も頭に入れておく必要がある。

* **サービス終了のリスク**

CDNを提供しているサービスの中には、サービスが終了してしまったものもある。

近年だと、2019年にサービス終了した「RawGit」がある。

### セキュリティ

CDNが悪意の第三者により書き換えられてしまう可能性もある。

そこで、SRIと呼ばれるセキュリティチェックの仕組みが用意されている。

**サブリソース完全性(SRI)**

JavaScriptのライブラリを取り込む`<script>`要素には、サブリソース完全性 **(SRI)** と呼ばれる検証機能が備わっている。

SRIとはJavaScriptのライブラリが改ざんされていないかどうかをハッシュ関数を用いて検証する機能のこと。

**SRIの仕組み**

もし第三者によってライブラリが改ざんされることがあれば、ライブラリのハッシュ値が変化してしまうため、危険なライブラリを読み込む前に読み込みエラーとなる。

### SRIを使ったCDNの利用方法

`script`要素を使用して、以下のように記述する。

```
<script src="URL" integrity="ハッシュ関数-ハッシュ値" crossorigin="anonymous"></script>
```

integrity属性で指定するハッシュ関数とハッシュ値は、SRI Hash Generator(https://www.srihash.org/) というツールを使用すると生成してくれる。

### integrity属性

integrity属性とは、スクリプトなどを読み込む際に改ざんされていないかどうかをチェックをするための属性。

link要素とscript要素で使用可能。

ブラウザが計算したハッシュ値と、integrity属性で指定しているハッシュ値が異なると、改ざんされていると判断してスクリプトが実行されない仕組みとなっている。

### crossorigin属性

crossorigin属性とは、JavaScriptや画像などを他のドメインから読み込む際にかかる制限をコントロールするための属性。

違うドメインから画像などを読み込むことを、**クロスオリジン**と呼ぶ。

通常は、Webページの脆弱性を防ぐため、同一ドメインの**リソース**(JavaScriptや画像)のみしかアクセスできないよう制限がかかっている。  
crossorigin属性を指定してあげることで、その制限を解除することができる。

crossorigin属性の値には以下の2種類がある。

||意味|
|-|-|
|`anonymous`|CookieやSSL証明書、HTTP認証などの信用情報は送信されない。|
|`use-credentials`|CookieやSSL証明書、HTTP認証などの信用情報が送信される。credentialは「証明書」の意味。|

### ドメインとオリジンの違い

ドメイン:`yahoo.co.jp`  
オリジン:`https://yahoo.co.jp:443`

オリジンのドメインとの違いは、**プロトコルとポート番号を含んでいる**という点。

つまり、**オリジン**とは、**ドメインにプロトコルとポート番号を付与したもの**といえる。

**ポート番号**とは、TCP/IP通信において、 コンピュータが通信に使用する**プログラムを識別する**ための番号のこと。

IPアドレスがあればネットワーク上のコンピュータを一意に識別することができるが、プログラムまでは識別できないのでポート番号が必要になる。

### HTTPリクエスト

HTTPリクエストとは、Webブラウザとサーバーがやりとりする時に、ブラウザがサーバーに送る要求(リクエスト)のこと。  

要するに、「このページくださ～い」ってやつ。

HTTPリクエストは、以下の3つで構成される。

    * リクエスト行
    * ヘッダーフィールド
    * ボディ

リクエスト行は、メソッド(GETやPOST)、URI、HTTPバージョンの3つの要素から構成され、それぞれスペースで区切られる。

**URI**とは、URL(住所)とURN(名前)の総称。つまり、URI=URL+URNとなる。

URLは変わるけど、URN(名前)はずっと変わらない点に注意。

### CORSとは

別のオリジンのサーバーへのアクセスをHTTPリクエストによって許可できる仕組みのこと。Cross-Origin Resource Sharing の略

要するに、HTTPリクエストを送ることで別のオリジンにある画像やJavaScriptにアクセスできるようになる仕組みってことだね。

CORSは同一オリジンポリシーを拡張したものであることから、**CORSポリシー**と呼ばれることもある。

CORSでは、特定のドメインにロードされたクライアントウェブアプリケーション(webページなど)が異なるドメイン内のリソースと通信する方法を定義している。

以下の表現もあった。

```
CORS (Cross-Origin Resource Sharing) はSOPの例外ルールのひとつです。
異なるオリジンへのHTTPリクエストが発生するさいに、相手側オリジンからの許可を得ることでアクセスを可能にするプロトコルです。
```

プロトコルと考えるとしっくりくるね。

### 同一オリジンポリシー

同一オリジンポリシー(Same Origin Policy)とは、異なるオリジンから読み込まれたリソースへのアクセスをブロックすることにより、元オリジンで読み込まれたリソースに対して悪い影響を及ぼさないようにすることを目的としたWeb ブラウザが持つセキュリティ機能のこと。

頭文字をとって**SOP**とも呼ばれる。

SOPは**異なるオリジン（クロスオリジンとも呼ばれる）のリソースとの通信・アクセスを制限する。**

**具体例**

Aというサイトにある画像が、Bというサイトで読み込まれそうになったらそれをブロックする。

### CORSと同一オリジンポリシーの関係

同一オリジンポリシーによって設けられた制限を緩めるのがCORS。

* **WordPressでCORSのトラブル!?**

ちなみにwebサイトを作成する際によく使われるWordPressを利用しているユーザーの中には、CORSポリシーの制限によって、サイトに画像が表示されないトラブルが発生している人もいた。

### SOPによって制限されるもの

いくつかあるが、ここではよく使うものを一部ピックアップする。

* **許可されていないcanvasタグによる別オリジンの画像の読み込み**

>「CORS」による許可なしに異なるオリジンから読み込まれた画像・データをcanvasタグ内に描画するとcanvasタグは汚染（taint）される。   
汚染されたcanvasタグは安全とみなされなくなり、データへのアクセス（getImageData()、toBlob()、toDataURL()）が制限される。

**汚染**とは、Perl由来の機能で、以下の意味がある。

>外部から入力されるデータ(引数、環境変数、ファイル入力等)に対して
汚染チェックが行われ、「そのまま」その値を使用(例えば system でコマンド実行)
できないようにするオプション。

要するに、外部から入ってきたデータにたいして、そのままの状態で実行できないようにするオプションのこと。

また、以下の記述にある通り、Perlでの汚染機能は、あくまでエラーチェックをしなくていいんか？とプログラマにたいして通知する機能のこと。

>あくまでコーディング中に、プログラマに「この変数はチェックしないでええんかコラ」と
通知するための機能。
>オプションをつけて実行させて、「変な値が来たときはエラーにする」などのエラーチェック
を行うためのオプションではなく、「エラーチェックをプログラマに実装させるよう注意喚起
する」ためのオプション。
>
>当然実行速度は遅くなる。






